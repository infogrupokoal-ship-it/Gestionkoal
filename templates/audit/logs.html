{% extends "base.html" %}
{% block title %}Auditoría{% endblock %}
{% block content %}
<h1>Auditoría</h1>

<form method="get" style="margin-bottom:12px;display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap;">
  <label for="type">Tipo</label>
  <select id="type" name="type">
    <option value="" {% if not f_type %}selected{% endif %}>Todos</option>
    <option value="error" {% if f_type=='error' %}selected{% endif %}>Error</option>
    <option value="whatsapp" {% if f_type=='whatsapp' %}selected{% endif %}>WhatsApp</option>
    <option value="ai" {% if f_type=='ai' %}selected{% endif %}>IA</option>
    <option value="notification" {% if f_type=='notification' %}selected{% endif %}>Notificación</option>
  </select>
  <label for="q">Buscar</label>
  <input type="text" id="q" name="q" value="{{ q or '' }}" placeholder="texto...">
  <label for="start">Desde</label>
  <input type="text" id="start" name="start" value="{{ start or '' }}" placeholder="YYYY-MM-DD">
  <label for="end">Hasta</label>
  <input type="text" id="end" name="end" value="{{ end or '' }}" placeholder="YYYY-MM-DD">
  <button type="submit">Filtrar</button>
  <a href="{{ url_for('audit.list_logs') }}">Limpiar</a>
  <a href="{{ url_for('audit.list_logs', type=f_type or None, q=q or None, start=start or None, end=end or None, export='csv') }}">Exportar CSV</a>
</form>

<table>
  <thead>
    <tr>
      <th>Fecha</th>
      <th>Tipo</th>
      <th>Resumen</th>
      <th>Detalles</th>
    </tr>
  </thead>
  <tbody>
  {% for row in items %}
    <tr>
      <td>{{ row.ts }}</td>
      <td>{{ row.type }}</td>
      <td>{{ row.summary }}</td>
      <td><pre style="white-space:pre-wrap;max-width:640px;">{{ row.details }}</pre></td>
    </tr>
  {% else %}
    <tr><td colspan="4">Sin eventos aún.</td></tr>
  {% endfor %}
  </tbody>
  </table>
{% if total %}
  <div style="margin-top:10px;display:flex;gap:8px;align-items:center;">
    <span>Página {{ page }} de {{ (total // per_page) + (1 if total % per_page else 0) }}</span>
    {% if page > 1 %}
      <a href="{{ url_for('audit.list_logs', type=f_type or None, q=q or None, start=start or None, end=end or None, page=page-1, per_page=per_page) }}">Anterior</a>
    {% endif %}
    {% if (page * per_page) < total %}
      <a href="{{ url_for('audit.list_logs', type=f_type or None, q=q or None, start=start or None, end=end or None, page=page+1, per_page=per_page) }}">Siguiente</a>
    {% endif %}
  </div>
{% endif %}
{% endblock %}
