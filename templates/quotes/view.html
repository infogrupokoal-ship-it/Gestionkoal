{% extends "base.html" %}

{% block title %}Ver/Editar Presupuesto #{{ presupuesto.id }}{% endblock %}

{% block content %}
    <h1>Presupuesto #{{ presupuesto.id }}</h1>
    <div class="formulario">
        <form method="post">
            <label for="estado">Estado del Presupuesto</label>
            <select id="estado" name="estado">
                {% set estados = ['pendiente', 'aceptado', 'rechazado'] %}
                {% for estado_option in estados %}
                <option value="{{ estado_option }}" {% if estado_option == presupuesto.estado %}selected{% endif %}>{{ estado_option|capitalize }}</option>
                {% endfor %}
            </select>

            <h2>Items del Presupuesto</h2>
            <div id="items-container">
                {# Template for new items #}
                <div class="item-row-template" style="display: none;">
                    <label>Descripción</label>
                    <input type="text" name="item_descripcion[]" placeholder="Descripción del ítem">

                    <label>Cantidad</label>
                    <input type="number" step="0.01" name="item_qty[]" value="1">

                    <label>Precio Unitario (€)</label>
                    <input type="number" step="0.01" name="item_precio_unit[]" value="0.00">
                    <button type="button" class="remove-item-btn">Eliminar</button>
                </div>

                {# Existing items #}
                {% for item in items %}
                <div class="item-row">
                    <input type="hidden" name="item_id[]" value="{{ item.id }}">
                    <label>Descripción</label>
                    <input type="text" name="item_descripcion[]" value="{{ item.descripcion or '' }}" placeholder="Descripción del ítem">

                    <label>Cantidad</label>
                    <input type="number" step="0.01" name="item_qty[]" value="{{ item.qty or '' }}">

                    <label>Precio Unitario (€)</label>
                    <input type="number" step="0.01" name="item_precio_unit[]" value="{{ item.precio_unit or '' }}">
                    <button type="button" class="remove-item-btn">Eliminar</button>
                </div>
                {% endfor %}
            </div>
            <button type="button" id="add-item-btn">Añadir Ítem</button>

            <button type="submit">Actualizar Presupuesto</button>
        </form>
        <form action="{{ url_for('quotes.delete_quote', quote_id=presupuesto.id) }}" method="post" style="display:inline;">
            <button type="submit" class="btn btn-danger" onclick="return confirm('¿Estás seguro de que quieres eliminar este presupuesto y todos sus ítems?');">Eliminar Presupuesto</button>
        </form>
    </div>

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const itemsContainer = document.getElementById('items-container');
        const itemRowTemplate = document.querySelector('.item-row-template');
        const addItemBtn = document.getElementById('add-item-btn');
        const grandTotalDisplay = document.createElement('p');
        grandTotalDisplay.innerHTML = '<strong>Total Presupuesto: <span id="grand-total">0.00</span> €</strong>';
        itemsContainer.parentNode.insertBefore(grandTotalDisplay, itemsContainer.nextSibling);

        function calculateTotals() {
            let grandTotal = 0;
            itemsContainer.querySelectorAll('.item-row').forEach(row => {
                const qtyInput = row.querySelector('input[name="item_qty[]"]');
                const priceInput = row.querySelector('input[name="item_precio_unit[]"]');
                
                const qty = parseFloat(qtyInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                
                const itemTotal = qty * price;
                grandTotal += itemTotal;
            });
            document.getElementById('grand-total').textContent = grandTotal.toFixed(2);
        }

        function attachListenersToRow(row) {
            const qtyInput = row.querySelector('input[name="item_qty[]"]');
            const priceInput = row.querySelector('input[name="item_precio_unit[]"]');

            qtyInput.addEventListener('input', calculateTotals);
            priceInput.addEventListener('input', calculateTotals);
        }

        function addRow() {
            const newRow = itemRowTemplate.cloneNode(true);
            newRow.classList.remove('item-row-template');
            newRow.style.display = 'block';
            newRow.classList.add('item-row');
            // Clear values in the new row
            newRow.querySelectorAll('input').forEach(input => {
                if (input.type === 'hidden') input.value = ''; // Clear item_id
                else if (input.type === 'number') input.value = '0.00';
                else input.value = '';
            });
            itemsContainer.appendChild(newRow);
            attachRemoveListeners(newRow);
            attachListenersToRow(newRow); // Attach calculation listeners
            updateRemoveButtons();
            calculateTotals(); // Recalculate after adding row
        }

        function attachRemoveListeners(row) {
            const removeBtn = row.querySelector('.remove-item-btn');
            if (removeBtn) {
                removeBtn.addEventListener('click', function() {
                    if (itemsContainer.querySelectorAll('.item-row').length > 1) {
                        row.remove();
                        updateRemoveButtons();
                        calculateTotals(); // Recalculate after removing row
                    } else {
                        alert('Debe haber al menos un ítem.');
                    }
                });
            }
        }

        // Attach listeners to initial rows
        itemsContainer.querySelectorAll('.item-row').forEach(attachListenersToRow);
        itemsContainer.querySelectorAll('.item-row').forEach(attachRemoveListeners);

        addItemBtn.addEventListener('click', addRow);

        // Enable/disable remove buttons based on row count
        function updateRemoveButtons() {
            const currentRows = itemsContainer.querySelectorAll('.item-row');
            if (currentRows.length <= 1) {
                currentRows.forEach(row => {
                    const btn = row.querySelector('.remove-item-btn');
                    if (btn) btn.disabled = true;
                });
            } else {
                currentRows.forEach(row => {
                    const btn = row.querySelector('.remove-item-btn');
                    if (btn) btn.disabled = false;
                });
            }
        }
        updateRemoveButtons();
        calculateTotals(); // Initial calculation on load

    });
</script>
{% endblock %}
