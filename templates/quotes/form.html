{% extends "base.html" %}

{% block title %}Crear Presupuesto{% endblock %}

{% block content %}
    <h1>Crear Presupuesto para Trabajo #{{ trabajo.id }}</h1>
    <div class="form-wrapper">
        <form method="post" class="form-card">
            <input type="hidden" name="trabajo_id" value="{{ trabajo.id }}">

            <div class="form-group">
                <label for="estado">Estado del Presupuesto</label>
                <select id="estado" name="estado" class="form-control">
                    {% for estado_option in estados %}
                    <option value="{{ estado_option }}" {% if presupuesto and presupuesto.estado == estado_option %}selected{% endif %}>{{ estado_option|capitalize }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="fecha_vencimiento">Fecha de Vencimiento</label>
                <input type="date" id="fecha_vencimiento" name="fecha_vencimiento" value="{{ presupuesto.fecha_vencimiento if presupuesto else '' }}" class="form-control">
            </div>

            <h2>Items del Presupuesto</h2>
            <div id="items-container">
                {# Template for new items #}
                <div class="item-row-template" style="display: none;">
                    <div class="form-group">
                        <label>Descripción</label>
                        <input type="text" name="item_descripcion[]" placeholder="Descripción del ítem" class="form-control">
                    </div>

                    <div class="form-group">
                        <label>Cantidad</label>
                        <input type="number" step="0.01" name="item_qty[]" value="1" class="form-control">
                    </div>

                    <div class="form-group">
                        <label>Precio Unitario (€)</label>
                        <input type="number" step="0.01" name="item_precio_unit[]" value="0.00" class="form-control">
                    </div>
                    <button type="button" class="remove-item-btn btn btn-danger btn-sm">Eliminar</button>
                </div>

                {# Initial empty row #}
                <div class="item-row">
                    <div class="form-group">
                        <label>Descripción</label>
                        <input type="text" name="item_descripcion[]" placeholder="Descripción del ítem" class="form-control">
                    </div>

                    <div class="form-group">
                        <label>Cantidad</label>
                        <input type="number" step="0.01" name="item_qty[]" value="1" class="form-control">
                    </div>

                    <div class="form-group">
                        <label>Precio Unitario (€)</label>
                        <input type="number" step="0.01" name="item_precio_unit[]" value="0.00" class="form-control">
                    </div>
                    <button type="button" class="remove-item-btn btn btn-danger btn-sm">Eliminar</button>
                </div>
            </div>
            <button type="button" id="add-item-btn" class="btn btn-secondary">Añadir Ítem</button>

            <button type="submit" class="btn btn-primary">Guardar Presupuesto</button>
            <button type="button" id="fill-example-btn" class="btn btn-secondary">Rellenar Ejemplo</button>
        </form>
    </div>

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const itemsContainer = document.getElementById('items-container');
        const itemRowTemplate = document.querySelector('.item-row-template');
        const addItemBtn = document.getElementById('add-item-btn');
        const grandTotalDisplay = document.createElement('p');
        grandTotalDisplay.innerHTML = '<strong>Total Presupuesto: <span id="grand-total">0.00</span> €</strong>';
        itemsContainer.parentNode.insertBefore(grandTotalDisplay, itemsContainer.nextSibling);

        function calculateTotals() {
            let grandTotal = 0;
            itemsContainer.querySelectorAll('.item-row').forEach(row => {
                const qtyInput = row.querySelector('input[name="item_qty[]"]');
                const priceInput = row.querySelector('input[name="item_precio_unit[]"]');
                
                const qty = parseFloat(qtyInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                
                const itemTotal = qty * price;
                grandTotal += itemTotal;
            });
            document.getElementById('grand-total').textContent = grandTotal.toFixed(2);
        }

        function attachListenersToRow(row) {
            const qtyInput = row.querySelector('input[name="item_qty[]"]');
            const priceInput = row.querySelector('input[name="item_precio_unit[]"]');

            qtyInput.addEventListener('input', calculateTotals);
            priceInput.addEventListener('input', calculateTotals);
        }

        function addRow() {
            const newRow = itemRowTemplate.cloneNode(true);
            newRow.classList.remove('item-row-template');
            newRow.style.display = 'block';
            newRow.classList.add('item-row');
            // Clear values in the new row
            newRow.querySelectorAll('input').forEach(input => {
                if (input.type === 'number') input.value = '0.00';
                else input.value = '';
            });
            itemsContainer.appendChild(newRow);
            attachRemoveListeners(newRow);
            attachListenersToRow(newRow); // Attach calculation listeners
            updateRemoveButtons();
            calculateTotals(); // Recalculate after adding row
        }

        function attachRemoveListeners(row) {
            const removeBtn = row.querySelector('.remove-item-btn');
            if (removeBtn) {
                removeBtn.addEventListener('click', function() {
                    if (itemsContainer.querySelectorAll('.item-row').length > 1) {
                        row.remove();
                        updateRemoveButtons();
                        calculateTotals(); // Recalculate after removing row
                    } else {
                        alert('Debe haber al menos un ítem.');
                    }
                });
            }
        }

        // Attach listeners to initial rows
        itemsContainer.querySelectorAll('.item-row').forEach(attachListenersToRow);
        itemsContainer.querySelectorAll('.item-row').forEach(attachRemoveListeners);

        addItemBtn.addEventListener('click', addRow);

        function updateRemoveButtons() {
            const currentRows = itemsContainer.querySelectorAll('.item-row');
            if (currentRows.length <= 1) {
                currentRows.forEach(row => {
                    const btn = row.querySelector('.remove-item-btn');
                    if (btn) btn.disabled = true;
                });
            }
            else {
                currentRows.forEach(row => {
                    const btn = row.querySelector('.remove-item-btn');
                    if (btn) btn.disabled = false;
                });
            }
        }
        updateRemoveButtons();
        calculateTotals(); // Initial calculation on load

        // Fill Example button logic
        document.getElementById('fill-example-btn').addEventListener('click', function() {
            // Clear existing items first
            itemsContainer.querySelectorAll('.item-row').forEach(row => row.remove());
            
            // Add example items
            addRow(); // First item
            document.querySelector('input[name="item_descripcion[]"]').value = 'Mano de obra (2 horas)';
            document.querySelector('input[name="item_qty[]"]').value = '2';
            document.querySelector('input[name="item_precio_unit[]"]').value = '35.00';

            addRow(); // Second item
            const secondRow = itemsContainer.querySelectorAll('.item-row')[1];
            secondRow.querySelector('input[name="item_descripcion[]"]').value = 'Material: Grifo monomando';
            secondRow.querySelector('input[name="item_qty[]"]').value = '1';
            secondRow.querySelector('input[name="item_precio_unit[]"]').value = '75.00';

            calculateTotals();
        });
    });
</script>
{% endblock %}