{% extends "base.html" %}

{% block title %}Detalles del Trabajo{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Inicio</a></li>
    <li class="breadcrumb-item"><a href="{{ url_for('jobs.list_jobs') }}">Trabajos</a></li>
    <li class="breadcrumb-item active" aria-current="page">Ver Trabajo #{{ job.id }}</li>
  </ol>
</nav>
{% endblock %}

{% block content %}
    <div class="content-header">
        <h1>Detalles del Trabajo #{{ job['id'] }}</h1>
        <a href="{{ url_for('jobs.list_jobs') }}" class="btn btn-secondary">Volver a la Lista</a>
    </div>

    <div class="profile-container">
        <div class="profile-details">
            <h3>Información General del Trabajo</h3>
            <dl class="row">
                <dt class="col-sm-3">Descripción</dt>
                <dd class="col-sm-9">{{ job['descripcion'] }}</dd>

                <dt class="col-sm-3">Estado</dt>
                <dd class="col-sm-9"><span class="status status-{{ job['estado'] | lower | replace(' ', '-') }}">{{ job['estado'] }}</span></dd>

                <dt class="col-sm-3">Prioridad</dt>
                <dd class="col-sm-9">{{ job['prioridad'] | default('Normal', true) }}</dd>

                <dt class="col-sm-3">Tipo de Trabajo</dt>
                <dd class="col-sm-9">{{ job['tipo_trabajo'] | default('No especificado', true) }}</dd>

                <dt class="col-sm-3">Ubicación</dt>
                <dd class="col-sm-9">{{ job['ubicacion'] | default('No especificada', true) }}</dd>

                <dt class="col-sm-3">Observaciones</dt>
                <dd class="col-sm-9">{{ job['observaciones'] | default('Sin observaciones', true) }}</dd>

                {% if job.imagen_url %}
                <dt class="col-sm-3">Imagen del Trabajo</dt>
                <dd class="col-sm-9">
                    <img src="{{ job.imagen_url }}" alt="Imagen del Trabajo" class="job-image-thumbnail">
                </dd>
                {% endif %}
            </dl>

            <h3>Fechas</h3>
            <dl class="row">
                <dt class="col-sm-3">Fecha de Creación</dt>
                <dd class="col-sm-9">{{ job['fecha_creacion'] }}</dd>

                <dt class="col-sm-3">Fecha de Inicio</dt>
                <dd class="col-sm-9">{{ job['fecha_inicio'] | default('Pendiente', true) }}</dd>

                <dt class="col-sm-3">Fecha de Fin</dt>
                <dd class="col-sm-9">{{ job['fecha_fin'] | default('Pendiente', true) }}</dd>

                <dt class="col-sm-3">Fecha de Cierre</dt>
                <dd class="col-sm-9">{{ job['fecha_cierre'] | default('Pendiente', true) }}</dd>
            </dl>

            <h3>Cliente</h3>
            <dl class="row">
                <dt class="col-sm-3">Nombre del Cliente</dt>
                <dd class="col-sm-9"><a href="{{ url_for('clients.view_client', client_id=job['cliente_id']) }}">{{ job['client_name'] }}</a></dd>

                <dt class="col-sm-3">Teléfono del Cliente</dt>
                <dd class="col-sm-9">{{ job['client_phone'] | default('N/A', true) }}</dd>

                <dt class="col-sm-3">Email del Cliente</dt>
                <dd class="col-sm-9">{{ job['client_email'] | default('N/A', true) }}</dd>
            </dl>

            <h3>Asignado a</h3>
            <dl class="row">
                <dt class="col-sm-3">Usuario Asignado</dt>
                <dd class="col-sm-9"><a href="{{ url_for('users.view_user', user_id=job.Ticket.asignado_a) }}">{{ job.assigned_user_name or 'N/A' }}</a></dd>

                <dt class="col-sm-3">Email Asignado</dt>
                <dd class="col-sm-9">{{ job.assigned_user_email or 'N/A' }}</dd>

                <dt class="col-sm-3">Socio Comercial</dt>
                <dd class="col-sm-9">{{ job.comercial_name or 'N/A' }}</dd>
            </dl>

            <h3>Información Financiera</h3>
            <dl class="row">
                <dt class="col-sm-3">Presupuesto Aprobado</dt>
                <dd class="col-sm-9">{{ 'Sí' if job['presupuesto_aprobado'] else 'No' }}</dd>

                <dt class="col-sm-3">Estado de Firma</dt>
                <dd class="col-sm-9">
                    {% if job['client_signature_data'] %}
                        Firmado por {{ job['client_signed_by'] }} el {{ job['client_signature_date'] }}
                        {% if job['signed_pdf_url'] %}
                            (<a href="{{ job['signed_pdf_url'] }}" target="_blank">Ver PDF Firmado</a>)
                        {% endif %}
                    {% else %}
                        Pendiente de firma
                    {% endif %}
                </dd>

                {% if not job['client_signature_data'] and job['presupuesto_aprobado'] %}
                <dt class="col-sm-3"></dt>
                <dd class="col-sm-9">
                    <form action="{{ url_for('quotes.send_quote_for_signature', quote_id=job['id']) }}" method="post" style="display:inline;">
                        <button type="submit" class="btn btn-info btn-sm">Enviar Presupuesto para Firma</button>
                    </form>
                </dd>
                {% endif %}

                <dt class="col-sm-3">Costo Estimado</dt>
                <dd class="col-sm-9">{{ "%.2f"|format(job['costo_estimado']) if job['costo_estimado'] is not none else 'N/A' }} €</dd>

                <dt class="col-sm-3">Costo Real</dt>
                <dd class="col-sm-9">{{ "%.2f"|format(job['costo_real']) if job['costo_real'] is not none else 'N/A' }} €</dd>

                <dt class="col-sm-3">Margen de Beneficio</dt>
                <dd class="col-sm-9">{{ "%.2f"|format(job['margen_beneficio']) if job['margen_beneficio'] is not none else 'N/A' }} %</dd>

                <dt class="col-sm-3">Método de Pago</dt>
                <dd class="col-sm-9">{{ job['metodo_pago'] | default('N/A', true) }}</dd>

                <dt class="col-sm-3">Estado de Pago</dt>
                <dd class="col-sm-9">{{ job['estado_pago'] | default('N/A', true) }}</dd>

                <dt class="col-sm-3">Fecha de Pago</dt>
                <dd class="col-sm-9">{{ job['fecha_pago'] | default('N/A', true) }}</dd>

                <dt class="col-sm-3">Provisión de Fondos</dt>
                <dd class="col-sm-9">{{ "%.2f"|format(job['provision_fondos']) if job['provision_fondos'] is not none else 'N/A' }} €</dd>

                <dt class="col-sm-3">Fecha de Transferencia</dt>
                <dd class="col-sm-9">{{ job['fecha_transferencia'] | default('N/A', true) }}</dd>
            </dl>

            <h3>Servicios Asociados</h3>
            {% if services %}
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Servicio</th>
                                <th>Descripción</th>
                                <th>Cantidad</th>
                                <th>Precio Unitario</th>
                                <th>Precio Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for service in services %}
                            <tr>
                                <td><a href="{{ url_for('services.view_service', service_id=service['service_id']) }}">{{ service['name'] }}</a></td>
                                <td>{{ service['description'] | default('N/A', true) }}</td>
                                <td>{{ service['quantity'] }}</td>
                                <td>{{ "%.2f"|format(service['price_per_unit']) if service['price_per_unit'] is not none else 'N/A' }} €</td>
                                <td>{{ "%.2f"|format(service['total_price']) if service['total_price'] is not none else 'N/A' }} €</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p>No hay servicios asociados a este trabajo.</p>
            {% endif %}

            <h3>Materiales Asociados</h3>
            {% if materials %}
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Material</th>
                                <th>SKU</th>
                                <th>Cantidad</th>
                                <th>Precio Unitario</th>
                                <th>Precio Total</th>
                                <th>Precio Sugerido (Estudio)</th> <!-- New Header -->
                                <th>Dificultad</th> <!-- New Header -->
                                <th>Solicitar Cotización / Cotizaciones Existentes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for material in materials %}
                            <tr>
                                <td><a href="{{ url_for('materials.view_material', material_id=material['material_id']) }}">{{ material['nombre'] }}</a></td>
                                <td>{{ material['sku'] | default('N/A', true) }}</td>
                                <td>{{ material['quantity'] }}</td>
                                <td>{{ "%.2f"|format(material['price_per_unit']) if material['price_per_unit'] is not none else 'N/A' }} €</td>
                                <td>{{ "%.2f"|format(material['total_price']) if material['total_price'] is not none else 'N/A' }} €</td>
                                <td>
                                    {% if material['market_study'] %}
                                        Min: {{ "%.2f"|format(material['market_study']['price_min']) if material['market_study']['price_min'] is not none else 'N/A' }} €<br>
                                        Avg: {{ "%.2f"|format(material['market_study']['price_avg']) if material['market_study']['price_avg'] is not none else 'N/A' }} €<br>
                                        Max: {{ "%.2f"|format(material['market_study']['price_max']) if material['market_study']['price_max'] is not none else 'N/A' }} €
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                                <td>
                                    {% if material['market_study'] %}
                                        <span class="status status-{{ material['market_study']['difficulty'] | lower }}">{{ material['market_study']['difficulty'] | capitalize }}</span>
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                                <td>
                                    <!-- Display existing quotes for this material -->
                                    {% if quotes_by_material[material['material_id']] %}
                                        <div class="existing-quotes">
                                            <strong>Cotizaciones:</strong><br>
                                            {% for quote in quotes_by_material[material['material_id']] %}
                                                <span>
                                                    {{ quote['provider_name'] }}: {{ "%.2f"|format(quote['quote_amount']) if quote['quote_amount'] is not none else 'N/A' }} €
                                                    (<span class="status status-{{ quote['status'] | lower }}">{{ quote['status'] | capitalize }}</span>)
                                                    {% if quote['payment_status'] %}
                                                        - Pago: <span class="status status-{{ quote['payment_status'] | lower }}">{{ quote['payment_status'] | capitalize }}</span>
                                                        {% if quote['payment_date'] %}({{ quote['payment_date'] }}){% endif %}
                                                    {% endif %}
                                                </span><br>
                                            {% endfor %}
                                        </div>
                                        <hr>
                                    {% endif %}

                                    <!-- Quote Request Form -->
                                    <form action="{{ url_for('jobs.request_material_quote', job_id=job['id'], material_id=material['material_id']) }}" method="post">
                                        <div class="form-group">
                                            <label for="provider_id_{{ material['material_id'] }}">Proveedor:</label>
                                            <select name="provider_id" id="provider_id_{{ material['material_id'] }}" class="form-control" required>
                                                <option value="">Seleccionar Proveedor</option>
                                                {% for provider in providers %}
                                                    <option value="{{ provider['id'] }}">{{ provider['nombre'] }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <button type="submit" class="btn btn-sm btn-primary mt-2">Solicitar Cotización</button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p>No hay materiales asociados a este trabajo.</p>
            {% endif %}

            <h3>Presupuestos de Autónomos</h3>
            {% if freelancer_quotes %}
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Autónomo</th>
                                <th>Total</th>
                                <th>Estado</th>
                                <th>Fecha Creación</th>
                                <th>Entidad Facturación</th>
                                <th>Archivos</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for f_quote in freelancer_quotes %}
                            <tr>
                                <td>{{ f_quote['freelancer_name'] }}</td>
                                <td>{{ "%.2f"|format(f_quote['total']) }} €</td>
                                <td><span class="status status-{{ f_quote['estado'] | lower | replace(' ', '-') }}">{{ f_quote['estado'] }}</span></td>
                                <td>{{ f_quote['fecha_creacion'] }}</td>
                                <td>{{ f_quote['billing_entity_type'] }} (ID: {{ f_quote['billing_entity_id'] }})</td>
                                <td>
                                    {% if f_quote['files'] %}
                                        <ul>
                                            {% for file in f_quote['files'] %}
                                                <li><a href="{{ file.url }}" target="_blank">{{ file.url.split('/')[-1] }}</a></li>
                                            {% endfor %}
                                        </ul>
                                    {% else %}
                                        Sin archivos
                                    {% endif %}
                                </td>
                                <td>
                                    {% if f_quote['estado'] == 'Enviado' and current_user.has_permission('approve_quotes') %}
                                        <form action="{{ url_for('jobs.approve_freelancer_quote', quote_id=f_quote.id) }}" method="post" style="display:inline;">
                                            <button type="submit" class="btn btn-success btn-sm">Aprobar</button>
                                        </form>
                                        <form action="{{ url_for('jobs.reject_freelancer_quote', quote_id=f_quote.id) }}" method="post" style="display:inline;">
                                            <button type="submit" class="btn btn-danger btn-sm">Rechazar</button>
                                        </form>
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p>No hay presupuestos de autónomos asociados a este trabajo.</p>
            {% endif %}

        </div>
        <div class="mt-4">
             <a href="{{ url_for('jobs.edit_job', job_id=job['id']) }}" class="btn btn-primary">Editar Trabajo</a>
             {% if current_user.has_permission('create_invoices') %}
             <a href="{{ url_for('invoicing.create_invoice_from_job', job_id=job['id']) }}" class="btn btn-info">Generar Factura</a>
             {% endif %}
             {% if current_user.has_permission('add_time_sheets') %}
             <a href="{{ url_for('invoicing.add_time_sheet', job_id=job['id']) }}" class="btn btn-secondary">Añadir Parte de Horas</a>
             {% endif %}
        </div>
    </div>

    <div class="profile-container mt-4">
        <h3>Facturas Asociadas</h3>
        {% if invoices %}
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID Factura</th>
                            <th>Fecha Emisión</th>
                            <th>Total Neto</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for invoice in invoices %}
                        <tr>
                            <td>#{{ invoice.id }}</td>
                            <td>{{ invoice.fecha_emision }}</td>
                            <td>{{ "%.2f"|format(invoice.total_neto) }} €</td>
                            <td><span class="status status-{{ invoice.estado | lower }}">{{ invoice.estado | capitalize }}</span></td>
                            <td class="actions">
                                <a href="{{ url_for('invoicing.view_invoice', invoice_id=invoice.id) }}" class="btn btn-secondary" aria-label="Ver"><i data-lucide="eye"></i></a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p>No hay facturas asociadas a este trabajo.</p>
        {% endif %}
    </div>

    <div class="profile-container mt-4">
        <h3>Partes de Horas Asociados</h3>
        {% if time_sheets %}
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID Parte</th>
                            <th>Fecha</th>
                            <th>Horas</th>
                            <th>Descripción</th>
                            <th>Costo Total</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ts in time_sheets %}
                        <tr>
                            <td>#{{ ts.id }}</td>
                            <td>{{ ts.fecha }}</td>
                            <td>{{ "%.2f"|format(ts.horas_trabajadas) }}</td>
                            <td>{{ ts.descripcion or 'N/A' }}</td>
                            <td>{{ "%.2f"|format(ts.costo_total) }} €</td>
                            <td class="actions">
                                <a href="{{ url_for('invoicing.edit_time_sheet', time_sheet_id=ts.id) }}" class="btn btn-secondary" aria-label="Editar"><i data-lucide="edit"></i></a>
                                <form action="{{ url_for('invoicing.delete_time_sheet', time_sheet_id=ts.id) }}" method="post" style="display:inline;">
                                    <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('¿Estás seguro de que quieres eliminar este parte de horas?');">Eliminar</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p>No hay partes de horas asociados a este trabajo.</p>
        {% endif %}
    
    <div class="profile-container mt-4">
        <h3>Bitácora de Actividad</h3>
        {% if activity_log %}
            <ul class="timeline">
                {% for log in activity_log %}
                    <li>
                        <div class="timeline-badge"></div>
                        <div class="timeline-panel">
                            <div class="timeline-heading">
                                <h4 class="timeline-title">{{ log.action | replace('_', ' ') | title }}</h4>
                                <p><small class="text-muted"><i class="fa fa-clock-o"></i> {{ log.timestamp }} por {{ log.user.username if log.user else 'Sistema' }}</small></p>
                            </div>
                            <div class="timeline-body">
                                <p>{{ log.details }}</p>
                            </div>
                        </div>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>No hay actividad registrada para este trabajo.</p>
        {% endif %}
    </div>
{% endblock %}