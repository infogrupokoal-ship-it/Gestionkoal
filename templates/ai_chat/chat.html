<div class="chat-container">
    <div class="chat-header">
        <h2>Asistente de Chat IA</h2>
    </div>

    {% if not AI_CHAT_ENABLED %}
    <div class="alert alert-warning" style="margin: 10px 20px;">
        El chat de IA está deshabilitado. El administrador debe configurar <code>GEMINI_API_KEY</code>.
    </div>
    {% endif %}

    <div class="chat-window" id="chat-window">
        {% for message in chat_history %}
            <div class="chat-message {{ 'user-message' if message.role == 'user' else 'ai-message' }}">
                <strong>{{ message.role }}:</strong> {{ message.parts[0] | replace('\n', '<br>') | safe }}
            </div>
        {% endfor %}
    </div>

    <form class="chat-input-form" id="ai-chat-form">
        <textarea class="form-control" id="message" name="message" placeholder="Escribe tu mensaje aquí..." autofocus></textarea>
        <button type="submit" class="btn btn-primary">Enviar</button>
    </form>

    <form method="post" action="{{ url_for('ai_chat.clear_history') }}" style="display:inline; margin-top: 10px;">
        <button type="submit" id="clear-history-btn" class="btn btn-secondary" title="Limpiar Historial">Limpiar</button>
    </form>

    <script>
        var chatWindow = document.getElementById('chat-window');
        chatWindow.scrollTop = chatWindow.scrollHeight;

        const aiChatForm = document.getElementById('ai-chat-form');
        const messageInput = document.getElementById('message');

        aiChatForm.addEventListener('submit', async function(event) {
            event.preventDefault();

            const userMessage = messageInput.value.trim();
            if (!userMessage) return;

            // Add user message to chat window
            appendMessage('user', userMessage);
            messageInput.value = ''; // Clear input

            // Extract context
            const currentUrl = window.location.href;
            let jobId = null;
            const jobMatch = currentUrl.match(/\/jobs\/(\d+)/);
            if (jobMatch) {
                jobId = parseInt(jobMatch[1]);
            }

            const payload = {
                message: userMessage,
                job_id: jobId,
                current_url: currentUrl
            };

            try {
                const response = await fetch('{{ url_for('ai_chat.submit') }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.error) {
                    appendMessage('error', data.error);
                } else {
                    appendMessage('model', data.reply);
                }
            } catch (error) {
                console.error('Error sending message to AI:', error);
                appendMessage('error', 'Error al conectar con el asistente de IA.');
            }
        });

        function appendMessage(role, text) {
            const chatWindow = document.getElementById('chat-window');
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message');
            messageDiv.classList.add(role === 'user' ? 'user-message' : 'ai-message');
            messageDiv.innerHTML = `<strong>${role}:</strong> ${text.replace(/\n/g, '<br>')}`;
            chatWindow.appendChild(messageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // Scroll to the bottom of the chat window on load
        if (chatWindow) {
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
    </script>
</div>