<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>{% block title %}Gestión de Trabajos{% endblock %} - Grupo Koal</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css', v=6) }}">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <!-- FullCalendar JS -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <!-- FullCalendar Spanish Locale -->
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.11/locales/es.global.min.js'></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('global-search-input');
            const searchResults = document.getElementById('search-results');
            let searchTimeout;

            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const query = this.value;

                if (query.length < 2) {
                    searchResults.innerHTML = '';
                    searchResults.style.display = 'none';
                    return;
                }

                searchTimeout = setTimeout(function() {
                    fetch(`/api/global_search?q=${query}`)
                        .then(response => response.json())
                        .then(data => {
                            let html = '';
                            if (data.materiales.length > 0) {
                                html += '<h3>Materiales</h3><ul>';
                                data.materiales.forEach(item => {
                                    html += `<li><a href="/materiales/${item.id}">${item.nombre} - ${item.descripcion}</a></li>`;
                                });
                                html += '</ul>';
                            }
                            if (data.servicios.length > 0) {
                                html += '<h3>Servicios</h3><ul>';
                                data.servicios.forEach(item => {
                                    html += `<li><a href="/servicios/${item.id}">${item.nombre} - ${item.descripcion}</a></li>`;
                                });
                                html += '</ul>';
                            }
                            if (data.trabajos.length > 0) {
                                html += '<h3>Trabajos</h3><ul>';
                                data.trabajos.forEach(item => {
                                    html += `<li><a href="/jobs/${item.id}">${item.titulo} - ${item.descripcion}</a></li>`;
                                });
                                html += '</ul>';
                            }

                            if (html) {
                                searchResults.innerHTML = html;
                                searchResults.style.display = 'block';
                            } else {
                                searchResults.innerHTML = '<p>No se encontraron resultados.</p>';
                                searchResults.style.display = 'block';
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching search results:', error);
                            searchResults.innerHTML = '<p>Error al buscar.</p>';
                            searchResults.style.display = 'block';
                        });
                }, 300); // Debounce time
            });

            // Hide search results when clicking outside
            document.addEventListener('click', function(event) {
                if (!searchInput.contains(event.target) && !searchResults.contains(event.target)) {
                    searchResults.style.display = 'none';
                }
            });
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('global-search-input');
            const searchResults = document.getElementById('search-results');
            let searchTimeout;

            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const query = this.value;

                if (query.length < 2) {
                    searchResults.innerHTML = '';
                    searchResults.style.display = 'none';
                    return;
                }

                searchTimeout = setTimeout(function() {
                    fetch(`/api/global_search?q=${query}`)
                        .then(response => response.json())
                        .then(data => {
                            let html = '';
                            if (data.materiales.length > 0) {
                                html += '<h3>Materiales</h3><ul>';
                                data.materiales.forEach(item => {
                                    html += `<li><a href="/materiales/${item.id}">${item.nombre} - ${item.descripcion}</a></li>`;
                                });
                                html += '</ul>';
                            }
                            if (data.servicios.length > 0) {
                                html += '<h3>Servicios</h3><ul>';
                                data.servicios.forEach(item => {
                                    html += `<li><a href="/servicios/${item.id}">${item.nombre} - ${item.descripcion}</a></li>`;
                                });
                                html += '</ul>';
                            }
                            if (data.trabajos.length > 0) {
                                html += '<h3>Trabajos</h3><ul>';
                                data.trabajos.forEach(item => {
                                    html += `<li><a href="/jobs/${item.id}">${item.titulo} - ${item.descripcion}</a></li>`;
                                });
                                html += '</ul>';
                            }

                            if (html) {
                                searchResults.innerHTML = html;
                                searchResults.style.display = 'block';
                            } else {
                                searchResults.innerHTML = '<p>No se encontraron resultados.</p>';
                                searchResults.style.display = 'block';
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching search results:', error);
                            searchResults.innerHTML = '<p>Error al buscar.</p>';
                            searchResults.style.display = 'block';
                        });
                }, 300); // Debounce time
            });

            // Hide search results when clicking outside
            document.addEventListener('click', function(event) {
                if (!searchInput.contains(event.target) && !searchResults.contains(event.target)) {
                    searchResults.style.display = 'none';
                }
            });
        });
    </script>
</head>
<body>
    <header class="main-header">
        <div class="header-container">
            <a href="{{ url_for('index') if current_user.is_authenticated else url_for('auth.login') }}"
       class="brand-name">
      Grupo Koal
    </a>
            <div class="search-container">
                <input type="text" id="global-search-input" placeholder="Buscar...">
                <div id="search-results" class="search-results-dropdown"></div>
            </div>
<nav>
  {% if current_user.is_authenticated %}
    <a href="{{ url_for('index') }}">Inicio</a>
    <a href="{{ url_for('materials.list_materials') }}">Materiales</a>
    <a href="{{ url_for('services.list_services') }}">Servicios</a>
    <a href="{{ url_for('gemini_ui.probar') }}">IA</a>
    {% if current_user.is_admin %}
      <a href="{{ url_for('admin.manage_users') }}">Usuarios</a>
    {% endif %}

    <div class="dropdown">
      <a href="#" class="dropbtn">Herramientas y Utilidades</a>
      <div class="dropdown-content">

    <a href="{{ url_for('profile.user_profile') }}">Perfil</a>
    <a href="{{ url_for('feedback.feedback_form') }}">Reportar Error o Sugerencia</a>
    <a href="{{ url_for('auth.logout') }}">Cerrar Sesión ({{ current_user.username }})</a>
  {% else %}
    <a href="{{ url_for('about.about') }}">Quiénes Somos</a>
    <a href="{{ url_for('auth.login') }}">Iniciar Sesión</a>
    <a href="{{ url_for('auth.register') }}">Registrarse</a>
  {% endif %}
</nav>
<!-- Botón flotante para abrir el chat de IA -->
<div class="floating-ai-button" title="Abrir IA"
     onclick="document.getElementById('aiChatModal').showModal?.()">
  <img src="{{ url_for('static', filename='img/logo_koala.jpg', v=3) }}" alt="IA">
</div>

<!-- Botón flotante para añadir Tarea Rápida -->
<div class="floating-quick-task-button" title="Añadir Tarea Rápida"
     onclick="document.getElementById('quickTaskModal').showModal?.()">
  <img src="{{ url_for('static', filename='img/add_task_icon.png') }}" alt="Añadir Tarea">
</div>

<!-- Modal del Chat IA (repuesto) -->
<div id="aiChatModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="aiChatTitle" style="display:none;">
  <div class="modal-content">
    <button type="button" class="close-button" aria-label="Cerrar">&times;</button>
    <div id="aiChatModalBody"><!-- aquí se cargará el chat via fetch --></div>
  </div>
</div>

<!-- Modal de Tarea Rápida -->
<div id="quickTaskModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="quickTaskTitle" style="display:none;">
  <div class="modal-content">
    <button type="button" class="close-button" aria-label="Cerrar">&times;</button>
    <div id="quickTaskModalBody">
        <!-- Aquí se cargará el formulario de tarea rápida via fetch -->
        <iframe id="quickTaskIframe" src="{{ url_for('quick_task.add_quick_task') }}" frameborder="0" style="width:100%; height:100%;"></iframe>
    </div>
  </div>
</div>

<!-- Botón flotante de WhatsApp -->
<a href="https://wa.me/34611222333?text=Hola%20Grupo%20Koal" target="_blank" class="floating-whatsapp-button" title="Contactar por WhatsApp">
  <img src="{{ url_for('static', filename='img/whatsapp_icon.png') }}" alt="WhatsApp">
</a>

<script src="https://unpkg.com/lucide@latest"></script>
<script>lucide.createIcons();</script>
</body>
</html>