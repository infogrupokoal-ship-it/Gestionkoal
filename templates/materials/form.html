{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Inicio</a></li>
    <li class="breadcrumb-item"><a href="{{ url_for('materials.list_materials') }}">Materiales</a></li>
    <li class="breadcrumb-item active" aria-current="page">{{ title }}</li>
  </ol>
</nav>
{% endblock %}

{% block content %}
<div class="form-wrapper">
    <div class="form-card">
        <h2 class="form-title">{{ title }}</h2>
        <form method="post" novalidate>
            {{ form.hidden_tag() }} {# CSRF token #}

            <div class="form-group">
                {{ form.sku.label }}
                {{ form.sku(class="form-control") }}
                {% for error in form.sku.errors %}
                    <span class="text-danger">{{ error }}</span>
                {% endfor %}
            </div>

            <div class="form-group">
                {{ form.nombre.label }}
                {{ form.nombre(class="form-control") }}
                {% for error in form.nombre.errors %}
                    <span class="text-danger">{{ error }}</span>
                {% endfor %}
            </div>

            <div class="form-group">
                {{ form.categoria.label }}
                {{ form.categoria(class="form-control") }}
                {% for error in form.categoria.errors %}
                    <span class="text-danger">{{ error }}</span>
                {% endfor %}
            </div>

            <div class="form-group">
                {{ form.unidad_medida.label }}
                {{ form.unidad_medida(class="form-control") }}
                {% for error in form.unidad_medida.errors %}
                    <span class="text-danger">{{ error }}</span>
                {% endfor %}
            </div>

            <div class="form-group">
                {{ form.stock_actual.label }}
                {{ form.stock_actual(class="form-control") }}
                {% for error in form.stock_actual.errors %}
                    <span class="text-danger">{{ error }}</span>
                {% endfor %}
            </div>

            <div class="form-group">
                {{ form.stock_minimo.label }}
                {{ form.stock_minimo(class="form-control") }}
                {% for error in form.stock_minimo.errors %}
                    <span class="text-danger">{{ error }}</span>
                {% endfor %}
            </div>

            <div class="form-group">
                {{ form.ubicacion.label }}
                {{ form.ubicacion(class="form-control") }}
                {% for error in form.ubicacion.errors %}
                    <span class="text-danger">{{ error }}</span>
                {% endfor %}
            </div>

            <div class="form-group">
                {{ form.precio_costo_estimado.label }}
                {{ form.precio_costo_estimado(class="form-control") }}
                {% for error in form.precio_costo_estimado.errors %}
                    <span class="text-danger">{{ error }}</span>
                {% endfor %}
            </div>

            <div class="form-group">
                {{ form.precio_venta_sugerido.label }}
                {{ form.precio_venta_sugerido(class="form-control") }}
                {% for error in form.precio_venta_sugerido.errors %}
                    <span class="text-danger">{{ error }}</span>
                {% endfor %}
            </div>

            <div class="form-group">
                {{ form.proveedor_sugerido.label }}
                {{ form.proveedor_sugerido(class="form-control") }}
                {% for error in form.proveedor_sugerido.errors %}
                    <span class="text-danger">{{ error }}</span>
                {% endfor %}
            </div>

            <div class="form-group">
                {{ form.tiempo_entrega_dias.label }}
                {{ form.tiempo_entrega_dias(class="form-control") }}
                {% for error in form.tiempo_entrega_dias.errors %}
                    <span class="text-danger">{{ error }}</span>
                {% endfor %}
            </div>

            <div class="form-group">
                {{ form.observaciones.label }}
                {{ form.observaciones(class="form-control") }}
                {% for error in form.observaciones.errors %}
                    <span class="text-danger">{{ error }}</span>
                {% endfor %}
            </div>

            <div class="form-group">
                {{ form.fecha_ultimo_ingreso.label }}
                {{ form.fecha_ultimo_ingreso(class="form-control") }}
                {% for error in form.fecha_ultimo_ingreso.errors %}
                    <span class="text-danger">{{ error }}</span>
                {% endfor %}
            </div>

            <div class="form-group">
                {{ form.cantidad_total_usada.label }}
                {{ form.cantidad_total_usada(class="form-control") }}
                {% for error in form.cantidad_total_usada.errors %}
                    <span class="text-danger">{{ error }}</span>
                {% endfor %}
            </div>

            <div class="form-group">
                {{ form.proveedor_id.label }}
                {{ form.proveedor_id(class="form-control") }}
                {% for error in form.proveedor_id.errors %}
                    <span class="text-danger">{{ error }}</span>
                {% endfor %}
            </div>

            {# Display Market Study Data #}
            {% if market_study_data %}
            <div class="market-study-info">
                <h4>Estudio de Mercado (<span class="status status-{{ market_study_data['difficulty'] | lower }}">{{ market_study_data['difficulty'] | capitalize }}</span>)</h4>
                <p>Precio Sugerido: Min {{ "%.2f"|format(market_study_data['price_min']) if market_study_data['price_min'] is not none else 'N/A' }} € - Avg {{ "%.2f"|format(market_study_data['price_avg']) if market_study_data['price_avg'] is not none else 'N/A' }} € - Max {{ "%.2f"|format(market_study_data['price_max']) if market_study_data['price_max'] is not none else 'N/A' }} €</p>
                <p>Fuentes: {{ market_study_data['sources_json'] | default('N/A') }}</p>
            </div>
            {% endif %}

            <div class="form-group">
                {{ form.comision_empresa.label }}
                {{ form.comision_empresa(class="form-control") }}
                {% for error in form.comision_empresa.errors %}
                    <span class="text-danger">{{ error }}</span>
                {% endfor %}
            </div>

            {{ form.submit(class="btn btn-primary") }}
            <button type="button" id="fill-example-btn" class="btn btn-secondary">Rellenar Ejemplo</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Autocomplete for Providers
        const providerSelect = document.getElementById('proveedor_id');
        if (providerSelect) {
            // No need for autocomplete if using a select field
            // The choices are already populated by Flask-WTF
        }

        // Example fill button
        document.getElementById('fill-example-btn').addEventListener('click', function() {
            document.getElementById('sku').value = 'MAT-9999';
            document.getElementById('nombre').value = 'ejem. Martillo de Bola';
            document.getElementById('categoria').value = 'Herramientas Manuales';
            document.getElementById('unidad_medida').value = 'ud';
            document.getElementById('stock_actual').value = '20';
            document.getElementById('stock_minimo').value = '5';
            document.getElementById('ubicacion').value = 'Almacén 1, Estantería A';
            document.getElementById('precio_costo_estimado').value = '12.50';
            document.getElementById('precio_venta_sugerido').value = '25.00';
            document.getElementById('proveedor_sugerido').value = 'Proveedor A';
            document.getElementById('tiempo_entrega_dias').value = '3';
            document.getElementById('observaciones').value = 'Material de alta calidad.';
            document.getElementById('fecha_ultimo_ingreso').value = '2023-10-26';
            document.getElementById('cantidad_total_usada').value = '10';
            document.getElementById('comision_empresa').value = '15.0';
            // Para el proveedor_id, selecciona el primero si existe
            const proveedorIdSelect = document.getElementById('proveedor_id');
            if (proveedorIdSelect.options.length > 1) {
                proveedorIdSelect.value = proveedorIdSelect.options[1].value;
            }
        });
    });
</script>
{% endblock %}