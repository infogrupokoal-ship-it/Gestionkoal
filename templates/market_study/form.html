{% extends "base.html" %}

{% block title %}Gestión de Estudio de Mercado{% endblock %}

{% block content %}
    <h1>Gestión de Estudio de Mercado</h1>
    <div class="formulario">
        <form method="post">
            <label for="tipo_elemento">Tipo de Elemento</label>
            <select id="tipo_elemento" name="tipo_elemento" required>
                <option value="">-- Selecciona Tipo --</option>
                <option value="material" {% if study and study.tipo_elemento == 'material' %}selected{% endif %}>Material</option>
                <option value="servicio" {% if study and study.tipo_elemento == 'servicio' %}selected{% endif %}>Servicio</option>
                <option value="tecnico" {% if study and study.tipo_elemento == 'tecnico' %}selected{% endif %}>Técnico</option>
            </select>

            <label for="elemento_id">Elemento Específico</label>
            <select id="elemento_id" name="elemento_id" required>
                <option value="">-- Selecciona Elemento --</option>
                {% if materials %}
                    <optgroup label="Materiales">
                        {% for material in materials %}
                            <option value="{{ material.id }}" data-type="material" {% if study and study.tipo_elemento == 'material' and study.elemento_id == material.id %}selected{% endif %}>{{ material.nombre }}</option>
                        {% endfor %}
                    </optgroup>
                {% endif %}
                {% if services %}
                    <optgroup label="Servicios">
                        {% for service in services %}
                            <option value="{{ service.id }}" data-type="servicio" {% if study and study.tipo_elemento == 'servicio' and study.elemento_id == service.id %}selected{% endif %}>{{ service.name }}</option>
                        {% endfor %}
                    </optgroup>
                {% endif %}
                {% if freelancers %}
                    <optgroup label="Técnicos">
                        {% for freelancer in freelancers %}
                            <option value="{{ freelancer.id }}" data-type="tecnico" {% if study and study.tipo_elemento == 'tecnico' and study.elemento_id == freelancer.id %}selected{% endif %}>{{ freelancer.username }}</option>
                        {% endfor %}
                    </optgroup>
                {% endif %}
            </select>

            <label for="region">Región (opcional)</label>
            <input type="text" id="region" name="region" value="{{ study.region if study else '' }}">

            <label for="factor_dificultad">Factor de Dificultad (1.0 = normal)</label>
            <input type="number" step="0.01" id="factor_dificultad" name="factor_dificultad" value="{{ study.factor_dificultad if study else '1.0' }}">

            <label for="recargo_urgencia">Recargo por Urgencia (%)</label>
            <input type="number" step="0.01" id="recargo_urgencia" name="recargo_urgencia" value="{{ study.recargo_urgencia if study else '0.0' }}">

            <label for="precio_recomendado">Precio Recomendado (€)</label>
            <input type="number" step="0.01" id="precio_recomendado" name="precio_recomendado" value="{{ study.precio_recomendado if study else '' }}" required>

            <button type="submit">Guardar Estudio</button>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const tipoElementoSelect = document.getElementById('tipo_elemento');
            const elementoIdSelect = document.getElementById('elemento_id');
            const optgroups = elementoIdSelect.querySelectorAll('optgroup');

            function filterElementos() {
                const selectedType = tipoElementoSelect.value;
                optgroups.forEach(optgroup => {
                    if (optgroup.label.toLowerCase().includes(selectedType)) {
                        optgroup.style.display = '';
                    } else {
                        optgroup.style.display = 'none';
                    }
                });
                // Reset selected element if its type doesn't match
                const selectedOption = elementoIdSelect.options[elementoIdSelect.selectedIndex];
                if (selectedOption && selectedOption.dataset.type !== selectedType) {
                    elementoIdSelect.value = '';
                }
            }

            tipoElementoSelect.addEventListener('change', filterElementos);
            filterElementos(); // Initial filter on load
        });
    </script>
{% endblock %}