{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
    <h1>{{ title }}</h1>
    <div class="form-wrapper">
        <form method="post" class="form-card">
            <div class="form-group">
                <label for="material_name">Material</label>
                <input type="text" id="material_name" name="material_name" list="material_suggestions" value="{{ study.material_name if study else '' }}" required class="form-control">
                <datalist id="material_suggestions"></datalist>
                <input type="hidden" id="material_id" name="material_id" value="{{ study.material_id if study else '' }}">
            </div>

            <div class="form-group">
                <label for="sector">Sector</label>
                <select id="sector" name="sector" required class="form-control">
                    {% for s in sectors %}
                    <option value="{{ s }}" {% if study and s == study['sector'] %}selected{% endif %}>{{ s }}</option>
                    {% endfor %}
                </select>
            </div>

            {% if study %}
            <div class="market-study-results results-card">
                <h2>Resultados del Estudio de Mercado</h2>
                <p><strong>Precio Promedio:</strong> {{ "%.2f"|format(study.price_avg) if study.price_avg is not none else 'N/A' }} €</p>
                <p><strong>Precio Mínimo:</strong> {{ "%.2f"|format(study.price_min) if study.price_min is not none else 'N/A' }} €</p>
                <p><strong>Precio Máximo:</strong> {{ "%.2f"|format(study.price_max) if study.price.max is not none else 'N/A' }} €</p>
                <p><strong>Dificultad:</strong> {{ study.difficulty.capitalize() if study.difficulty else 'N/A' }}</p>
                <p><strong>Fuentes:</strong></p>
                <ul>
                    {% for source in study.sources %}
                    <li>{{ source.source }} - {{ "%.2f"|format(source.price) }} € ({{ source.date }}) - {{ source.availability }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if workload_advice %}
            <div class="workload-advice results-card">
                <h2>Recomendación por Carga de Trabajo</h2>
                <p>{{ workload_advice }}</p>
                {% if recommended_price is not none %}
                <p><strong>Precio Recomendado (ajustado):</strong> {{ "%.2f"|format(recommended_price) }} €</p>
                {% endif %}
            </div>
            {% endif %}

            <button type="submit" class="btn btn-primary">Guardar Estudio</button>
        </form>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Autocompletado para Materiales
        const materialNameInput = document.getElementById('material_name');
        const materialIdInput = document.getElementById('material_id');
        const materialSuggestions = document.getElementById('material_suggestions');

        materialNameInput.addEventListener('input', function() {
            const query = this.value;
            if (query.length < 2) {
                materialSuggestions.innerHTML = '';
                materialIdInput.value = '';
                return;
            }

            fetch(`/autocomplete/materials?q=${query}`)
                .then(response => response.json())
                .then(data => {
                    materialSuggestions.innerHTML = '';
                    data.forEach(material => {
                        const option = document.createElement('option');
                        option.value = material.nombre;
                        option.setAttribute('data-id', material.id);
                        materialSuggestions.appendChild(option);
                    });
                });
        });

        materialNameInput.addEventListener('change', function() {
            const selectedOption = Array.from(materialSuggestions.options).find(option => option.value === this.value);
            if (selectedOption) {
                materialIdInput.value = selectedOption.getAttribute('data-id');
            } else {
                materialIdInput.value = '';
            }
        });
    });
</script>
{% endblock %}