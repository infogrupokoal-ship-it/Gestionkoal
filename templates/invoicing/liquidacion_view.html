{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Inicio</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('invoicing.list_liquidations') }}">Liquidaciones</a></li>
            <li class="breadcrumb-item active" aria-current="page">Liquidación #{{ liquidacion.Liquidacion.id }}</li>
        </ol>
    </nav>
    <h1 class="mb-4">Detalles de Liquidación #{{ liquidacion.Liquidacion.id }}</h1>

    <div class="card mb-4">
        <div class="card-header">
            Información General
        </div>
        <div class="card-body">
            <p><strong>Autónomo:</strong> {{ liquidacion.autonomo_name }}</p>
            <p><strong>Fecha de Liquidación:</strong> {{ liquidacion.Liquidacion.fecha_liquidacion.strftime('%d/%m/%Y') }}</p>
            <p><strong>Periodo:</strong> {{ liquidacion.Liquidacion.periodo_inicio.strftime('%d/%m/%Y') }} - {{ liquidacion.Liquidacion.periodo_fin.strftime('%d/%m/%Y') }}</p>
            <p><strong>Monto Total:</strong> {{ "%.2f"|format(liquidacion.Liquidacion.monto_total) }} €</p>
            <p><strong>Estado:</strong> 
                <span class="badge 
                    {% if liquidacion.Liquidacion.estado == 'pagada' %}bg-success
                    {% elif liquidacion.Liquidacion.estado == 'pendiente' %}bg-warning text-dark
                    {% else %}bg-secondary{% endif %}">
                    {{ liquidacion.Liquidacion.estado.capitalize() }}
                </span>
            </p>
            <p><strong>Última Actualización:</strong> {{ liquidacion.Liquidacion.updated_at.strftime('%d/%m/%Y %H:%M') }}</p>
            {% if liquidacion.Liquidacion.pdf_url %}
            <p><strong>PDF:</strong> <a href="{{ liquidacion.Liquidacion.pdf_url }}" target="_blank">Ver PDF</a></p>
            {% endif %}
        </div>
        <div class="card-footer text-end">
            {% if liquidacion.Liquidacion.estado == 'pendiente' %}
            <form action="{{ url_for('invoicing.mark_liquidacion_as_paid', liquidacion_id=liquidacion.Liquidacion.id) }}" method="POST" class="d-inline">
                <button type="submit" class="btn btn-success" onclick="return confirm('¿Estás seguro de marcar esta liquidación como pagada?')">Marcar como Pagada</button>
            </form>
            {% endif %}
            <a href="{{ url_for('invoicing.list_liquidations') }}" class="btn btn-secondary">Volver a Liquidaciones</a>
        </div>
    </div>

    <h2 class="mb-3">Partes de Horas Asociados</h2>
    {% if partes_horas_asociados %}
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Fecha</th>
                    <th>Horas</th>
                    <th>Descripción</th>
                    <th>Costo</th>
                    <th>Trabajo</th>
                </tr>
            </thead>
            <tbody>
                {% for parte in partes_horas_asociados %}
                <tr>
                    <td>{{ parte.ParteHoras.id }}</td>
                    <td>{{ parte.ParteHoras.fecha.strftime('%d/%m/%Y') }}</td>
                    <td>{{ "%.2f"|format(parte.ParteHoras.horas_trabajadas) }}</td>
                    <td>{{ parte.ParteHoras.descripcion }}</td>
                    <td>{{ "%.2f"|format(parte.ParteHoras.costo_total) }} €</td>
                    <td><a href="{{ url_for('jobs.view_job', job_id=parte.ParteHoras.ticket_id) }}">{{ parte.job_title }}</a></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="alert alert-info" role="alert">
        No hay partes de horas asociados a esta liquidación en el periodo seleccionado.
    </div>
    {% endif %}
</div>
{% endblock %}