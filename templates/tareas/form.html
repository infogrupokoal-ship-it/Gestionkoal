{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
    <h1>{{ title }}</h1>
    <div class="form-wrapper">
        <form method="post" class="form-card">
            <div class="form-group">
                <label for="descripcion">Descripción de la Tarea</label>
                <textarea id="descripcion" name="descripcion" required class="form-control">{{ tarea['descripcion'] if tarea else '' }}</textarea>
            </div>

            <div class="form-group">
                <label for="asignado_a">Asignar a</label>
                <select id="asignado_a" name="asignado_a" class="form-control">
                    <option value="">-- Sin Asignar --</option>
                    {% for user in users %}
                    <option value="{{ user.id }}" {% if tarea and user.id == tarea['asignado_a'] %}selected{% endif %}>{{ user.username }}</option>
                    {% endfor %}
                </select>
            </div>

            <div id="surcharge-suggestion" style="margin-top: 10px; padding: 10px; background-color: #f0f8ff; border: 1px solid #e0f2f7; border-radius: 5px; display: none;">
                <strong>Recargo Sugerido:</strong> <span id="suggested-amount">N/A</span>
            </div>

            <div class="form-group">
                <label for="metodo_pago">Método de Pago</label>
                <select id="metodo_pago" name="metodo_pago" class="form-control">
                    <option value="">-- Seleccionar Método --</option>
                    <option value="Efectivo" {% if tarea and tarea['metodo_pago'] == 'Efectivo' %}selected{% endif %}>Efectivo</option>
                    <option value="Tarjeta" {% if tarea and tarea['metodo_pago'] == 'Tarjeta' %}selected{% endif %}>Tarjeta</option>
                    <option value="Transferencia" {% if tarea and tarea['metodo_pago'] == 'Transferencia' %}selected{% endif %}>Transferencia</option>
                    <option value="Bizum" {% if tarea and tarea['metodo_pago'] == 'Bizum' %}selected{% endif %}>Bizum</option>
                </select>
            </div>

            <div class="form-group">
                <label for="provision_fondos">Provisión de Fondos (€)</label>
                <input type="number" id="provision_fondos" name="provision_fondos" step="0.01" value="{{ "%.2f"|format(tarea['provision_fondos']) if tarea and tarea['provision_fondos'] is not none else '' }}" class="form-control">
            </div>

            <div class="form-group">
                <label for="fecha_transferencia">Fecha de Transferencia</label>
                <input type="date" id="fecha_transferencia" name="fecha_transferencia" value="{{ tarea['fecha_transferencia'] if tarea else '' }}" class="form-control">
            </div>

            <div class="form-group">
                <label for="estado_pago">Estado de Pago</label>
                <select id="estado_pago" name="estado_pago" class="form-control">
                    <option value="Pendiente" {% if tarea and tarea['estado_pago'] == 'Pendiente' %}selected{% endif %}>Pendiente</option>
                    <option value="Pagado" {% if tarea and tarea['estado_pago'] == 'Pagado' %}selected{% endif %}>Pagado</option>
                    <option value="Facturado" {% if tarea and tarea['estado_pago'] == 'Facturado' %}selected{% endif %}>Facturado</option>
                    <option value="Reembolsado" {% if tarea and tarea['estado_pago'] == 'Reembolsado' %}selected{% endif %}>Reembolsado</option>
                </select>
            </div>

            {% if tarea %}
            <div class="form-group">
                <label for="estado">Estado</label>
                <select id="estado" name="estado" class="form-control">
                    {% set estados = ['pendiente', 'en_progreso', 'completado'] %}
                    {% for estado in estados %}
                    <option value="{{ estado }}" {% if tarea and estado == tarea['estado'] %}selected{% endif %}>{{ estado.replace('_', ' ').capitalize() }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}

            <button type="submit" class="btn btn-primary">Guardar Tarea</button>
            <a href="{{ url_for('jobs.edit_job', job_id=trabajo_id) }}" class="btn btn-secondary">Cancelar</a>
        </form>
    </div>
{% endblock %}

{% block scripts %}
<script>
    const usersData = {{ users | tojson }}; // Pass users data to JS
    const jobDifficulty = {{ job_difficulty_rating }}; // Pass job difficulty to JS

    const asignadoASelect = document.getElementById('asignado_a');
    const surchargeSuggestionDiv = document.getElementById('surcharge-suggestion');
    const suggestedAmountSpan = document.getElementById('suggested-amount');

    function calculateAndDisplaySurcharge() {
        const selectedUserId = asignadoASelect.value;
        if (selectedUserId) {
            const selectedUser = usersData.find(user => user.id == selectedUserId);
            if (selectedUser && selectedUser.effective_rate !== null) {
                const baseCost = selectedUser.effective_rate;
                const difficultyFactor = 1 + (0.05 * jobDifficulty); // Example: 5% per difficulty point

                const suggestedAmount = baseCost * difficultyFactor;
                suggestedAmountSpan.textContent = `${suggestedAmount.toFixed(2)} €`;
                surchargeSuggestionDiv.style.display = 'block';
            } else {
                surchargeSuggestionDiv.style.display = 'none';
            }
        } else {
            surchargeSuggestionDiv.style.display = 'none';
        }
    }

    asignadoASelect.addEventListener('change', calculateAndDisplaySurcharge);

    // Calculate on page load if a user is already selected
    calculateAndDisplaySurcharge();
</script>
{% endblock %}