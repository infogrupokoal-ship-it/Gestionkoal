# Gesti√≥n Koal - Aplicaci√≥n de Gesti√≥n de Servicios## Descripci√≥nEsta es la aplicaci√≥n de gesti√≥n de servicios de Grupo Koal, dise√±ada para optimizar la administraci√≥n de trabajos, clientes, materiales, proveedores y m√°s. Incluye funcionalidades como gesti√≥n de trabajos, cotizaciones v√≠a WhatsApp, estudio de mercado y autenticaci√≥n de usuarios.## Configuraci√≥n del Entorno de DesarrolloSigue estos pasos para configurar y ejecutar el proyecto en tu m√°quina local.### M√©todo R√°pido (Recomendado)Hemos creado scripts para automatizar todo el proceso de configuraci√≥n y arranque. Simplemente ejecuta el script correspondiente a tu sistema operativo desde la ra√≠z del proyecto.**En Windows (PowerShell):**```powershell.\scripts\run_local.ps1```**En macOS/Linux (Bash):**```bashchmod +x ./scripts/run_local.sh./scripts/run_local.sh```Estos scripts se encargar√°n de:1. Crear un entorno virtual (`.venv`).2. Instalar todas las dependencias de `requirements.txt`.3. Aplicar las migraciones de la base de datos (`flask db upgrade`).4. Sembrar la base de datos con datos iniciales (`flask seed`).5. Iniciar el servidor de desarrollo en `http://127.0.0.1:5000`.### M√©todo ManualSi prefieres configurar el entorno paso a paso:1.  **Clonar el Repositorio**    ```bash    git clone https://github.com/infogrupokoal-ship-it/Gestionkoal.git    cd Gestionkoal    ```2.  **Crear y Activar el Entorno Virtual**    ```bash    python -m venv .venv    # En Windows    .venv\Scripts\activate    # En macOS/Linux    source .venv/bin/activate    ```3.  **Instalar Dependencias**    ```bash    pip install -U pip wheel    pip install -r requirements.txt    ```4.  **Configurar Variables de Entorno**    Crea un archivo `.env.local` en la ra√≠z del proyecto copiando el ejemplo `.env.example`. Rellena las claves de API que necesites.    ```bash    # En Windows (cmd)    copy .env.example .env.local    # En macOS/Linux    cp .env.example .env.local    ```5.  **Crear y Sembrar la Base de Datos**    Aplica las migraciones y luego siembra los datos iniciales.    ```bash    # Establece la app de Flask (si no usas .env)    # export FLASK_APP=backend        flask db upgrade    flask seed    ```6.  **Ejecutar la Aplicaci√≥n**    ```bash    flask run --host=127.0.0.1 --port=5000    ```La aplicaci√≥n estar√° disponible en `http://127.0.0.1:5000` y el endpoint de salud en `http://127.0.0.1:5000/health`.## WhatsApp + IA- Webhook con firma HMAC (X-Hub-Signature-256 + WHATSAPP_APP_SECRET).- Idempotencia (whatsapp_message_id) y logs inbound/outbound (/whatsapp/logs).- DRY_RUN en desarrollo (WHATSAPP_DRY_RUN=1).- Plantillas de respuesta por prioridad y triage IA (modo mock si no hay GEMINI_API_KEY).## Seguridad- Rate limiting en /auth/login y webhook.- CSRF simple en login/registro (token en sesiÛn).## Variables de Entorno Clave- WhatsApp: WHATSAPP_PROVIDER, WHATSAPP_DRY_RUN, WHATSAPP_ACCESS_TOKEN, WHATSAPP_PHONE_NUMBER_ID, WHATSAPP_VERIFY_TOKEN, WHATSAPP_APP_SECRET.- IA: GEMINI_API_KEY (o demo).## Caracter√≠sticas Clave*   **Gesti√≥n de Trabajos:** Creaci√≥n, edici√≥n y seguimiento de trabajos/tickets, incluyendo m√©todos y estados de pago, provisiones de fondos y fechas de transferencia.*   **Gesti√≥n de Clientes y Proveedores:** Base de datos de contactos con informaci√≥n de WhatsApp y opciones de opt-in.*   **Gesti√≥n de Materiales y Servicios:** Cat√°logo, control de stock y seguimiento de movimientos.*   **Cotizaciones por WhatsApp:** Env√≠o de solicitudes de cotizaci√≥n a proveedores y procesamiento autom√°tico de sus respuestas para actualizar presupuestos.*   **Estudio de Mercado:** An√°lisis de precios, dificultad de trabajos y simulaci√≥n de b√∫squeda web para materiales.*   **Autenticaci√≥n y Roles de Usuario:** Control de acceso basado en roles con permisos detallados, p√°gina de perfil y selecci√≥n de rol durante el registro.*   **Asistente de IA (Chat):** Integraci√≥n de un asistente de IA para soporte y funcionalidades avanzadas.*   **Gesti√≥n de Activos:** Control de herramientas y equipos, incluyendo pr√©stamos y mantenimientos programados.*   **Notificaciones:** Sistema de notificaciones para eventos importantes y recordatorios v√≠a WhatsApp.*   **Registro de Errores y Auditor√≠a:** Monitoreo de errores y registro de actividades del usuario.## ContactoPara soporte o m√°s informaci√≥n, contacta a [info@grupokoal.com](mailto:info@grupokoal.com).## AuditorÌa- Vista unificada en /audit/logs con eventos de error_log, whatsapp_logs, i_logs y otifications (si existen).- Filtros simples por ahora vÌa navegador; ideal para inspecciÛn r·pida en soportes.## GuÌa R·pida (Windows / PowerShell)- Crear entorno y dependencias:  - py -m venv .venv  - .\.venv\Scripts\Activate.ps1  - pip install -r requirements.txt- Variables locales (opcional .env.local):  - FLASK_APP=backend:create_app  - WHATSAPP_DRY_RUN=1 (dev)- Inicializar y ejecutar:  - python -m flask run (por defecto en 5000)## Despliegue en Render (resumen)- Conectar repo, montar Disk (1GB+), variables:  - DB_PATH=/var/data/database.db, UPLOAD_FOLDER=/var/data/uploads  - WHATSAPP_ACCESS_TOKEN, WHATSAPP_PHONE_NUMBER_ID, WHATSAPP_VERIFY_TOKEN, WHATSAPP_APP_SECRET  - GEMINI_API_KEY (o demo para modo mock)- Build: pip install -r requirements.txt- Start: python run_waitress.py o gunicorn "backend:create_app()"## Variables Clave- WhatsApp: WHATSAPP_PROVIDER (meta|twilio), WHATSAPP_DRY_RUN, WHATSAPP_ACCESS_TOKEN, WHATSAPP_PHONE_NUMBER_ID, WHATSAPP_VERIFY_TOKEN, WHATSAPP_APP_SECRET- IA: GEMINI_API_KEY, GEMINI_MODEL- Seguridad: SECRET_KEY, SESSION_COOKIE_SECURE=1 (prod)## AuditorÌa y Logs- Vista unificada en /audit/logs (error_log, whatsapp_logs, ai_logs, notifications).- Logs WhatsApp con filtros en /whatsapp/logs.## Seguridad (Cabeceras opcionales)- Se puede habilitar HSTS (HTTPS) y CSP con variables de entorno:  - ENABLE_HSTS=1 (solo bajo HTTPS)  - ENABLE_CSP=1 (Content-Security-Policy tolerante para CDNs e inline JS actuales)- CSP actual (si se activa):  - default-src 'self'`r  - script-src 'self' https://cdn.jsdelivr.net  - style-src 'self' 'unsafe-inline' https:  - img-src 'self' data: https:  - ont-src 'self' data: https:  - connect-src 'self' https:  - rame-ancestors 'none'`r  - object-src 'none'`r### CSRF en APIs JSON- Formularios HTML incluyen autom·ticamente csrf_token oculto (inyectado por static/js/csrf_forms.js).- Para llamadas etch/AJAX a endpoints JSON bajo /api/ que mutan estado (POST/PUT/DELETE), envÌa la cabecera X-CSRF-Token con el valor de la sesiÛn.- Puedes inyectar el token en tu JS leyendo una meta tag `<meta name="csrf-token" content="{{ csrf_token }}">` si decides aÒadirla en tus plantillas.## Roles y PermisosMatriz usada por `current_user.has_permission()` (ver `backend/auth.py:67` aprox.).- admin: view_dashboard, manage_all_jobs, manage_clients, view_reports, manage_users, approve_quotes, manage_quotes, create_quotes- oficina: view_dashboard, manage_all_jobs, manage_clients, view_reports, manage_quotes, create_quotes- jefe_obra: view_dashboard, manage_all_jobs- tecnico: view_dashboard, manage_own_jobs- autonomo: view_dashboard, manage_own_jobs, create_quotes- cliente: view_dashboard, view_own_jobsNotas:- El men˙ ahora oculta enlaces seg˙n permisos del usuario.- Endpoints admin-only relevantes: `/audit/toggles`.## Paso a PostgresChecklist recomendado para migrar de SQLite a Postgres:- Usar Flask-Migrate/Alembic (ya configurado en `migrations/`).- Revisar SQLs raw: est·n encapsulados con `sqlalchemy.text()` y par·metros nombrados.- AÒadir Ìndices equivalentes en Postgres:  - tickets(cliente_id, created_at)  - whatsapp_logs(created_at)  - ai_logs(created_at)  - notifications(user_id, created_at)- Configurar `SQLALCHEMY_DATABASE_URI` con `DATABASE_URL` (formato Postgres) y aplicar `flask db upgrade`.- Validar tipos y longitudes (TEXT ? TEXT/VARCHAR seg˙n tamaÒo esperado).- Probar funciones que usan fechas con `CURRENT_TIMESTAMP`/`NOW()`.
## GuÌa para Contribuidores
Consulta AGENTS.md para conocer las pautas de estructura, comandos de desarrollo, estilo de cÛdigo, pruebas y flujo de pull requests antes de subir cambios.


## Plan de cierre y despliegue
1. **Salud basica**: confirma `curl http://127.0.0.1:5000/healthz` -> `{"status":"ok","db":"ok"}` antes de tocar prod.
2. **Dependencias y tests**: crea entorno (`python -m venv .venv`), instala `pip install -r requirements.txt` y ejecuta `pytest -q` hasta ver verde.
3. **Webhook DRY-RUN**: exporta `WHATSAPP_DRY_RUN=1` y reenvia `whatsapp_payload.json` a `/webhook/whatsapp` para validar que el log `whatsapp_message_logs` crece sin lanzar tracebacks.
4. **Arranque produccion**: usa `gunicorn "backend:create_app()" --bind 0.0.0.0:$PORT --workers 2 --timeout 120` (Procfile/Dockerfile/render.yaml ya lo referencian).
5. **Render**: aplica `render.yaml` (build `pip install -r requirements.txt`, start command de gunicorn, disco persistente en `/app/instance`). Define `SECRET_KEY`, `WHATSAPP_*`, `GEMINI_API_KEY`, `ENABLE_HSTS`, `ENABLE_CSP` via dashboard.

### Variables criticas
- `WHATSAPP_PROVIDER`, `WHATSAPP_ACCESS_TOKEN`, `WHATSAPP_APP_SECRET`, `WHATSAPP_PHONE_NUMBER_ID`, `WHATSAPP_VERIFY_TOKEN`.
- `WHATSAPP_DRY_RUN=1` en desarrollo para evitar envios reales.
- `GEMINI_API_KEY` o `GOOGLE_API_KEY` + `GOOGLE_CSE_ID` para las funciones IA y estudio de mercado.
- `ENABLE_HSTS` y `ENABLE_CSP` en `1` solo cuando Render sirve bajo HTTPS.

### Checklist final
- `/healthz` responde 200 en el entorno seleccionado.
- `pytest -q` + `ruff .` + `black --check .` sin errores.
- `webhook/whatsapp` acepta el payload de ejemplo y devuelve `{"ok":true,"dry_run":true}`.
- Procfile, Dockerfile y render.yaml apuntan a gunicorn y se versionaron junto al codigo.
